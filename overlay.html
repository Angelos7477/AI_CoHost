<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Overlay Panel</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: rgba(0, 0, 0, 0.0); /* Transparent for OBS */
      font-family: sans-serif;
      color: white;
    }

    #askai-overlay, #commentary-overlay, #event-overlay {
      display: none; /* ‚úÖ Start hidden */
      position: absolute;
      padding: 12px 20px;
      font-size: 20px;
      background: rgba(20, 20, 20, 0.4);
      border-radius: 12px;
      max-width: 60%;
      white-space: pre-wrap;
      box-shadow: 0 0 20px rgba(20, 20, 20, 0.60);
    }

    #cooldown-overlay {
      display: none; /* ‚úÖ Start hidden */
      position: absolute;
      top: 2%;
      left: 10px;
      padding: 6px 12px;
      font-size: 12px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 8px;
      max-width: 40%;
      white-space: pre-wrap;
      z-index: 999;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    #cost-overlay {
      /*display: none; /* ‚úÖ Start hidden */
      position: absolute;
      top: 2%;
      right: 12%;
      font-size: 12px;
      background: rgba(20, 20, 20, 0.4);
      padding: 8px 12px;
      border-radius: 10px;
    }

    #askai-overlay {
      bottom: 10%;
      left: 28%;
    }

    #commentary-overlay {
      top: 9%;
      left: 50%;
      transform: translateX(-50%);
    }

    #event-overlay {
      top: 9%;
      left: 5%;
    }
    #personality-icon {
      position: absolute;
      top: 23px;
      left: 50%;
      transform: translateX(-50%);
      width: 64px;
      height: 64px;
      z-index: 1000;
    }
    #mood-text {
      position: absolute;
      top: 4px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      font-weight: bold;
      color: white;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
      z-index: 1001;
    }
    #power-score-overlay {
      position: absolute;
      top: 20%;
      left: 10px;
      width: 220px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 12px;
      padding: 10px;
      font-size: 14px;
      z-index: 900;
      color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
    }
    .score-title {
      font-weight: bold;
      text-align: center;
      margin-bottom: 6px;
      color: #FFD700;
    }
    #score-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 4px 10px;
    }
  </style>
</head>
<body>
  <img id="personality-icon" src="icons/default.png" alt="Personality Icon" />

  <div id="askai-overlay">‚ùì Waiting for AskAI...</div>
  <div id="commentary-overlay">üéôÔ∏è Waiting for Commentary...</div>
  <div id="event-overlay">üéâ Waiting for Events...</div>
  <div id="power-score-overlay">
    <div class="score-title">üî• Player Power</div>
    <div id="score-grid"></div>
  </div>
  <div id="cooldown-overlay">‚è≥ Cooldown...</div>
  <div id="cost-overlay">üí∞ Cost: $0.00000</div>
  <div id="mood-text"> Personality Name...</div>

  <script>
    const askaiDiv = document.getElementById("askai-overlay");
    const commentaryDiv = document.getElementById("commentary-overlay");
    const eventDiv = document.getElementById("event-overlay");
    const costDiv = document.getElementById("cost-overlay");
    /*Personality icons*/
    const personalityIcon = document.getElementById("personality-icon");
    const iconMap = {
      "troll": "icons/troll.png",
      "smartass": "icons/smartass.png",
      "tsundere": "icons/tsundere.png",
      "edgelord": "icons/edgelord.png",
      "shakespeare": "icons/shakespeare.png",
      "genz": "icons/genz.png",
      "coach": "icons/coach.png",
      "hype": "icons/hype.png",
      "wholesome": "icons/wholesome.png",
      "sarcastic": "icons/sarcastic.png"
    };


    let ws = null;
    let reconnectTimeout = null;

    function connectWS() {
      console.log("[HTML] üîÑ Connecting to WebSocket...");
      ws = new WebSocket("ws://127.0.0.1:8765");

      ws.onopen = () => {
        console.log("[HTML] ‚úÖ WebSocket connected");
        if (reconnectTimeout) {
          clearTimeout(reconnectTimeout);
          reconnectTimeout = null;
        }
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log("[HTML] üì© Message received:", data);

        if (data.type === "askai") {
          askaiDiv.textContent = `‚ùì ${data.question}\nüí¨ ${data.answer}`;
          askaiDiv.style.display = "block"; // Show AskAI
        } else if (data.type === "commentary") {
          commentaryDiv.textContent = `üéôÔ∏è ${data.text}`;
          commentaryDiv.style.display = "block"; // Show Commentary
        } else if (data.type === "event") {
          eventDiv.textContent = `üéâ ${data.content}`;
          eventDiv.style.display = "block"; // Show Event
        } else if (data.type === "askai_hide") {
          askaiDiv.style.display = "none"; // Hide AskAI
        } else if (data.type === "commentary_hide") {
          commentaryDiv.style.display = "none"; // Hide Commentary
        } else if (data.type === "cooldown") {
          const cooldownDiv = document.getElementById("cooldown-overlay");
          cooldownDiv.textContent = `‚è≥ ${data.message}`;
          cooldownDiv.style.display = "block";
        } else if (data.type === "cooldown_hide") {
          const cooldownDiv = document.getElementById("cooldown-overlay");
          cooldownDiv.style.display = "none";
        } else if (data.type === "event_hide") {
          eventDiv.style.display = "none"; // Hide Event
        } else if (data.type === "cost") {
          const costDiv = document.getElementById("cost-overlay");
          costDiv.textContent = `üí∞ Total API Cost: $${parseFloat(data.amount).toFixed(4)}`;
          costDiv.style.display = "block";
        } else if (data.type === "mood") {
          const mode = data.text.toLowerCase();
          const icon = iconMap[mode] || "icons/default.png";
          personalityIcon.src = icon;
          document.getElementById("mood-text").textContent = mode.toUpperCase();  // üëà Add this line
          console.log("üîÑ Mood update via WebSocket:", mode);
        } else if (data.type === "power_scores") {
            const grid = document.getElementById("score-grid");
            grid.innerHTML = ""; // Clear previous scores
            data.players.forEach(p => {
              const nameDiv = document.createElement("div");
              nameDiv.textContent = p.name.length > 10 ? p.name.slice(0, 10) + "‚Ä¶" : p.name;
              const scoreDiv = document.createElement("div");
              scoreDiv.textContent = p.score.toFixed(1);
              if (p.score > 150) {
                scoreDiv.style.color = "#00FF00";
              } else if (p.score > 100) {
                scoreDiv.style.color = "#FFD700";
              } else {
                scoreDiv.style.color = "#FF5555";
              }
              grid.appendChild(nameDiv);
              grid.appendChild(scoreDiv);
            });
            document.getElementById("power-score-overlay").style.display = "block";
          } else {
            console.log("‚ö†Ô∏è Unknown message type:", data);
        }
      };

      ws.onerror = (e) => {
        console.log("[HTML] ‚ùå WebSocket error:", e);
        tryReconnect();
      };

      ws.onclose = () => {
        console.log("[HTML] ‚ö†Ô∏è WebSocket connection closed");
        tryReconnect();
      };
    }

    function tryReconnect() {
      if (!reconnectTimeout) {
        reconnectTimeout = setTimeout(() => {
          reconnectTimeout = null;
          connectWS();
        }, 5000);
      }
    }

    connectWS();
  </script>
</body>
</html>
