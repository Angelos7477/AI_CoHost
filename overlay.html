<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Overlay Panel</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: rgba(0, 0, 0, 0.0); /* Transparent for OBS */
      font-family: sans-serif;
      color: white;
    }

    #askai-overlay, #commentary-overlay, #event-overlay {
      display: none; /* ‚úÖ Start hidden */
      position: absolute;
      padding: 12px 20px;
      font-size: 20px;
      background: rgba(20, 20, 20, 0.4);
      border-radius: 12px;
      max-width: 60%;
      white-space: pre-wrap;
      box-shadow: 0 0 20px rgba(20, 20, 20, 0.60);
    }

    #cooldown-overlay {
      display: none; /* ‚úÖ Start hidden */
      position: absolute;
      top: 2%;
      left: 10px;
      padding: 6px 12px;
      font-size: 12px;
      background: rgba(0, 0, 0, 0.6);
      border-radius: 8px;
      max-width: 40%;
      white-space: pre-wrap;
      z-index: 999;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    #cost-overlay {
      /*display: none; /* ‚úÖ Start hidden */
      position: absolute;
      top: 2%;
      right: 12%;
      font-size: 12px;
      background: rgba(20, 20, 20, 0.4);
      padding: 8px 12px;
      border-radius: 10px;
    }

    #askai-overlay {
      bottom: 10%;
      left: 28%;
    }

    #commentary-overlay {
      top: 9%;
      left: 50%;
      transform: translateX(-50%);
    }

    #event-overlay {
      top: 9%;
      left: 5%;
    }
    #personality-icon {
      position: absolute;
      top: 23px;
      left: 50%;
      transform: translateX(-50%);
      width: 64px;
      height: 64px;
      z-index: 1000;
    }
    #mood-text {
      position: absolute;
      top: 4px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      font-weight: bold;
      color: white;
      text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
      z-index: 1001;
    }
    #power-score-overlay {
      position: absolute;
      top: 20%;
      left: 10px;
      width: 220px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 12px;
      padding: 10px;
      font-size: 14px;
      z-index: 900;
      color: white;
      box-shadow: 0 0 10px rgba(0,0,0,0.4);
    }
    .score-title {
      font-weight: bold;
      text-align: center;
      margin-bottom: 6px;
      color: #FFD700;
    }
    #score-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .lane-row {
      display: flex;
      height: 20px;
      justify-content: space-between; /* space between bars */
      gap: 4px; /* optional, for extra spacing */
      border-radius: 6px;
      /*overflow: hidden;*/
      margin-bottom: 1px;
      background: rgba(255, 255, 255, 0.1);
    }
    .player-bar {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0px 8px;
      font-size: 13px;
      font-weight: 600;
      color: white;
      border-radius: 8px;
      white-space: nowrap;
      overflow: visible;
      position: relative;
      transition: all 0.3s ease;
      box-shadow: 0 0 8px rgba(0,0,0,0.3);
    }
    /* ‚úÖ Add floating label */
    .player-bar::after {
      content: attr(data-label);
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
      white-space: nowrap;
      font-size: 12px;
      color: white;
      pointer-events: none;
    }
    .order {
      background: linear-gradient(to right, #005bbb, #00bfff);
      justify-content: flex-start;
    }
    .chaos {
      background: linear-gradient(to right, #ff5e62, #ff9966);
      justify-content: flex-end;
    }
    .team-score-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 6px;
    }
    .team-score {
      font-size: 14px;
      font-weight: 700;
      padding: 0px 8px;
      border-radius: 10px;
      background: rgba(255,255,255,0.1);
      box-shadow: 0 0 6px rgba(0,0,0,0.3);
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
    }
    .team-score.order {
      color: #cce5ff;
      background: linear-gradient(to right, #005bbb, #00bfff);
    }
    .team-score.chaos {
      color: #ffd6cc;
      background: linear-gradient(to right, #ff5e62, #ff9966);
    }

  </style>
</head>
<body>
  <img id="personality-icon" src="icons/default.png" alt="Personality Icon" />

  <div id="askai-overlay">‚ùì Waiting for AskAI...</div>
  <div id="commentary-overlay">üéôÔ∏è Waiting for Commentary...</div>
  <div id="event-overlay">üéâ Waiting for Events...</div>
  <div id="power-score-overlay">
    <div class="score-title">üî• Player Power</div>
    <div class="team-score-row">
      <div id="order-team-score" class="team-score order">ORDER: 0</div>
      <div id="chaos-team-score" class="team-score chaos">CHAOS: 0</div>
    </div>
    <div id="score-grid"></div>
  </div>
  <div id="cooldown-overlay">‚è≥ Cooldown...</div>
  <div id="cost-overlay">üí∞ Cost: $0.00000</div>
  <div id="mood-text"> Personality Name...</div>

  <script>
    const askaiDiv = document.getElementById("askai-overlay");
    const commentaryDiv = document.getElementById("commentary-overlay");
    const eventDiv = document.getElementById("event-overlay");
    const costDiv = document.getElementById("cost-overlay");
    /*Personality icons*/
    const personalityIcon = document.getElementById("personality-icon");
    const iconMap = {
      "troll": "icons/troll.png",
      "smartass": "icons/smartass.png",
      "tsundere": "icons/tsundere.png",
      "edgelord": "icons/edgelord.png",
      "shakespeare": "icons/shakespeare.png",
      "genz": "icons/genz.png",
      "coach": "icons/coach.png",
      "hype": "icons/hype.png",
      "wholesome": "icons/wholesome.png",
      "sarcastic": "icons/sarcastic.png"
    };


    let ws = null;
    let reconnectTimeout = null;

    function connectWS() {
      console.log("[HTML] üîÑ Connecting to WebSocket...");
      ws = new WebSocket("ws://127.0.0.1:8765");

      ws.onopen = () => {
        console.log("[HTML] ‚úÖ WebSocket connected");
        if (reconnectTimeout) {
          clearTimeout(reconnectTimeout);
          reconnectTimeout = null;
        }
      };

      ws.onmessage = (event) => {
        const data = JSON.parse(event.data);
        console.log("[HTML] üì© Message received:", data);

        if (data.type === "askai") {
          askaiDiv.textContent = `‚ùì ${data.question}\nüí¨ ${data.answer}`;
          askaiDiv.style.display = "block"; // Show AskAI
        } else if (data.type === "commentary") {
          commentaryDiv.textContent = `üéôÔ∏è ${data.text}`;
          commentaryDiv.style.display = "block"; // Show Commentary
        } else if (data.type === "event") {
          eventDiv.textContent = `üéâ ${data.content}`;
          eventDiv.style.display = "block"; // Show Event
        } else if (data.type === "askai_hide") {
          askaiDiv.style.display = "none"; // Hide AskAI
        } else if (data.type === "commentary_hide") {
          commentaryDiv.style.display = "none"; // Hide Commentary
        } else if (data.type === "cooldown") {
          const cooldownDiv = document.getElementById("cooldown-overlay");
          cooldownDiv.textContent = `‚è≥ ${data.message}`;
          cooldownDiv.style.display = "block";
        } else if (data.type === "cooldown_hide") {
          const cooldownDiv = document.getElementById("cooldown-overlay");
          cooldownDiv.style.display = "none";
        } else if (data.type === "event_hide") {
          eventDiv.style.display = "none"; // Hide Event
        } else if (data.type === "cost") {
          const costDiv = document.getElementById("cost-overlay");
          costDiv.textContent = `üí∞ Total API Cost: $${parseFloat(data.amount).toFixed(4)}`;
          costDiv.style.display = "block";
        } else if (data.type === "mood") {
          const mode = data.text.toLowerCase();
          const icon = iconMap[mode] || "icons/default.png";
          personalityIcon.src = icon;
          document.getElementById("mood-text").textContent = mode.toUpperCase();  // üëà Add this line
          console.log("üîÑ Mood update via WebSocket:", mode);
        } else if (data.type === "power_scores") {
          const grid = document.getElementById("score-grid");
          grid.innerHTML = "";
          document.getElementById("order-team-score").textContent = `ORDER: ${data.order_total}`;
          document.getElementById("chaos-team-score").textContent = `CHAOS: ${data.chaos_total}`;
          const roles = ["top", "jungle", "middle", "bottom", "utility"];
          const knownRoles = ["top", "jungle", "middle", "bottom", "utility"];
          roles.forEach(role => {
            const players = data.players.filter(p => p.role === role);
            if (players.length !== 2) return;
            const [p1, p2] = players;
            const total = p1.score + p2.score || 1;
            const row = document.createElement("div");
            row.className = "lane-row";
            const bar1 = document.createElement("div");
            const bar2 = document.createElement("div");
            const p1Width = `${(p1.score / total) * 100}%`;
            const p2Width = `${(p2.score / total) * 100}%`;
            bar1.className = "player-bar " + (p1.team === "ORDER" ? "order" : "chaos");
            bar1.style.width = p1Width;
            bar1.setAttribute("data-label", `${p1.name} (${Math.round(p1.score)})`);
            bar1.textContent = ""; // Remove inner text to avoid overflow
            bar2.className = "player-bar " + (p2.team === "ORDER" ? "order" : "chaos");
            bar2.style.width = p2Width;
            bar2.setAttribute("data-label", `${p2.name} (${Math.round(p2.score)})`);
            bar2.textContent = "";
            // Order matters: ORDER should always come first (left)
            if (p1.team === "ORDER") {
              row.appendChild(bar1);
              row.appendChild(bar2);
            } else {
              row.appendChild(bar2);
              row.appendChild(bar1);
            }
            grid.appendChild(row);
          });
          // ‚úÖ Fallback display for players with unknown role
          const unknownPlayers = data.players.filter(p => !knownRoles.includes(p.role));
          if (unknownPlayers.length >= 2) {
            const [p1, p2] = unknownPlayers.slice(0, 2); // Only show first 2
            const total = p1.score + p2.score || 1;
            const row = document.createElement("div");
            row.className = "lane-row";
            const bar1 = document.createElement("div");
            const bar2 = document.createElement("div");
            const p1Width = `${(p1.score / total) * 100}%`;
            const p2Width = `${(p2.score / total) * 100}%`;
            bar1.className = "player-bar " + (p1.team === "ORDER" ? "order" : "chaos");
            bar1.style.width = p1Width;
            bar1.setAttribute("data-label", `${p1.name} (${Math.round(p1.score)})`);
            bar1.textContent = ""; // Remove inner text to avoid overflow
            bar2.className = "player-bar " + (p2.team === "ORDER" ? "order" : "chaos");
            bar2.style.width = p2Width;
            bar2.setAttribute("data-label", `${p2.name} (${Math.round(p2.score)})`);
            bar2.textContent = "";
            if (p1.team === "ORDER") {
              row.appendChild(bar1);
              row.appendChild(bar2);
            } else {
              row.appendChild(bar2);
              row.appendChild(bar1);
            }
            grid.appendChild(row);
          } document.getElementById("power-score-overlay").style.display = "block";
        } else if (data.type === "toggle_power") {
          const overlay = document.getElementById("power-score-overlay");
          overlay.style.display = data.visible ? "block" : "none";
        } else {
                    console.log("‚ö†Ô∏è Unknown message type:", data);
                }
              };

      ws.onerror = (e) => {
        console.log("[HTML] ‚ùå WebSocket error:", e);
        tryReconnect();
      };

      ws.onclose = () => {
        console.log("[HTML] ‚ö†Ô∏è WebSocket connection closed");
        tryReconnect();
      };
    }

    function tryReconnect() {
      if (!reconnectTimeout) {
        reconnectTimeout = setTimeout(() => {
          reconnectTimeout = null;
          connectWS();
        }, 5000);
      }
    }

    connectWS();
  </script>
</body>
</html>
